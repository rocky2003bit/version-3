<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://sdk.cashfree.com/js/v3/cashfree.js"></script>
   

  <title>Cango - Pricing</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background:#f7f7f7; }
    .top { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:16px; }
    .card { background:#fff; border:1px solid #ddd; border-radius:10px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,0.06); }
    .price { font-size:28px; margin:10px 0; }
    button { padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
    .btn { background:#111; color:#fff; }
    .btn:disabled { opacity:0.6; cursor:not-allowed; }
    .muted { color:#666; font-size:14px; }
    .status { margin-top:10px; }
    .link { color:#0066cc; cursor:pointer; text-decoration:underline; }
    
  </style>


</head>
<body>

  <div class="top">
    <div>
      <h2 style="margin:0;">Cango Subscription</h2>
      <div class="muted">Subscribe to unlock ordering.</div>
    </div>
    <div>
      <span class="link" onclick="goHome()">← Back</span>
    </div>
  </div>

  <div id="meBox" class="card" style="margin-bottom:16px;">
    <div><strong>Your status:</strong> <span id="meStatus">Checking...</span></div>
    <div class="muted" id="meDetails"></div>
  </div>

  <div class="cards" id="plansBox">
    <!-- Plans render here -->
  </div>

  <p class="status" id="msg"></p>

<script>
  const plansBox = document.getElementById("plansBox");
  const msg = document.getElementById("msg");
  const meStatus = document.getElementById("meStatus");
  const meDetails = document.getElementById("meDetails");
   const cashfree = Cashfree({ mode: "sandbox" }); // change to production later

  function goHome(){
    window.location.href = "/original.html"; // change if your home is index.html
  }

  function requireLogin(){
    const token = localStorage.getItem("authToken");
    if (!token) {
      window.location.href = "/signin.html";
      return null;
    }
    return token;
  }

  async function loadMe(){
    const token = requireLogin();
    if (!token) return;

    const res = await fetch("/api/subscription/me", {
      headers: { "Authorization": "Bearer " + token }
    });

    const data = await res.json();
    if (data.subscribed) {
      meStatus.textContent = "Active ✅";
      meDetails.textContent = `Plan: ${data.plan} | Ends: ${new Date(data.end_at).toLocaleString()}`;
    } else {
      meStatus.textContent = "Not subscribed ❌";
      meDetails.textContent = "Choose a plan below to subscribe.";
    }
  }

  async function loadPlans(){
    const res = await fetch("/api/subscription/plans");
    if (!res.ok) {
      msg.textContent = "Failed to load plans.";
      return;
    }
    const plans = await res.json();

    plansBox.innerHTML = "";
    plans.forEach(p => {
      const div = document.createElement("div");
      div.className = "card";
      div.innerHTML = `
        <h3 style="margin:0;">${p.name}</h3>
        <div class="price">₹${p.price_inr}</div>
        <div class="muted">Duration: ${p.duration_days} days</div>
        <div style="margin-top:12px;">
          <button class="btn" onclick="subscribe(${p.id}, ${p.price_inr})">Subscribe</button>
        </div>
      `;
      plansBox.appendChild(div);
    });
  }

  // Step 3A: for now, just confirm plan click.
  // Next step (3B/4): this will call backend to create Cashfree order.
   async function subscribe(planId, amount){
  const token = requireLogin();
  if (!token) return;

  msg.textContent = "Creating order...";

  // 1) ask backend to create Cashfree order
  const r1 = await fetch("/api/subscription/create-order", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": "Bearer " + token
    },
    body: JSON.stringify({ planId })
  });

  const d1 = await r1.json();
  if (!r1.ok) {
    msg.textContent = d1.error || "Failed to create order";
    return;
  }

  // 2) open Cashfree checkout
  msg.textContent = "Opening checkout...";
  const paymentSessionId = d1.payment_session_id;
  const orderId = d1.order_id;

  try {
    await cashfree.checkout({
      paymentSessionId,
      redirectTarget: "_modal" // popup modal
    });

    // 3) after user completes/close, confirm with backend
    msg.textContent = "Verifying payment...";
    const r2 = await fetch("/api/subscription/confirm", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": "Bearer " + token
      },
      body: JSON.stringify({ orderId })
    });

    const d2 = await r2.json();
    if (d2.paid) {
      msg.textContent = d2.message;
      await loadMe();
    } else {
      msg.textContent = "Payment not completed. Status: " + (d2.order_status || "unknown");
    }
  } catch (e) {
    msg.textContent = "Checkout closed / failed.";
  }
}


  // init
  loadMe();
  loadPlans();
</script>

</body>
</html>
